<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<style type='text/css'>
  fn-metric-control {
    display:block;
    width: 100%;
    height: 70px;
    background: #fff;
  }
</style>
<template id="fn-metric-control-base-tpl">
  <style type='text/css'>
    .left {
      float: left;
    }

    .right {
      float:right;
    }

    

    .group {
      height: 100%;
      float: left;
      padding: 8px 20px 10px 20px;
    }

    .right fn-button {
      margin:20px 20px 0 0;
    }

    .group.group_by {
      display: none;
    }

    .group.group_by.active {
      display: block;
    }

    .group.group_by fn-button[data-active='active'] {
      background: rgb(226, 232, 237);
    }

    .group.group_by fn-button {
      float: left;
    }

    .group.aggregation_time_window {
      border-right: 1px solid rgb(226, 232, 237);
    }

    .group.aggregation_time_window fn-dropdown {
      float:left;
      margin-right: 20px;
    }

    .group.aggregation_time_window fn-dropdown:last-child {
      margin-right: 0;
    }

    .group.aggregation_type {
      border-right: 1px solid rgb(226, 232, 237);
    }

    .group b {
      font-weight: normal;
      font-size: 80%;
      line-height: 12px;
      font-weight: 500;
      display: block;
      margin-bottom: 6px;
      opacity: 0.7;
    }

    .group.scale fn-input /deep/ input {
      width: 40px;
      padding: 0.67861em 0.8em !important;
    }

    fn-tooltip {
      display: none;
      position: absolute;
      z-index: 900;
      border: 1px solid #cccccc;
      max-width: 250px;
      background-color: #ffffff;
      padding: 0.833em 1em;
      font-weight: normal;
      font-style: normal;
      color: rgba(0, 0, 0, 0.8);
      border-radius: 0.2857rem;
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
      font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;
      font-size: 12px;
      line-height: 1.1em;
      margin:0;
    }

    fn-tooltip:before {
      position: absolute;
      content: '';
      width: 0.75em;
      height: 0.75em;
      background: #ffffff;
      -webkit-transform: rotate(45deg);
          -ms-transform: rotate(45deg);
              transform: rotate(45deg);
      z-index: 2;
      box-shadow: 1px 1px 0px 0px #b3b3b3;
    }

    fn-tooltip[data-active] {
      display: block;
    }

    fn-tooltip:before {
      bottom: -0.325em;
      left: 1em;
      top: auto;
      right: auto;
      margin-left: 0em;
    }

    .metric {
      float:left;
      width: inherit;
      height: 70px;
    }

    .metric > .view {
      display: none;
      width: 250px;
      
    }

    .metric > .view.active {
      display: block;
    }

    .metric > .view > h3 {
      font-size: 1rem;
      padding: 0;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      width: inherit;
    }

    .metric .view fn-search {
      width: 180px;
    }

    .metric fn-search /deep/ .icon {
      margin-top: 0.65em;
    }

    .metric .view .fa:hover {
      cursor: pointer;
    }






  </style>
  <div class="left">
    <div class="metric">
      <div class="view active" name="header">
        <i class="fa fa-pencil-square-o" name="edit_btn"></i>
        <h3 class="small"></h3>
      </div>
      <div class="view" name="search">
        <i class="fa fa-times" name="close_btn"></i>
        <fn-search data-size="small" class="" data-placeholder="Search Metric...">
          <fn-search-icon><i class="fa fa-search"></i></fn-search-icon>
        </fn-search>
      </div>
    </div>
    <div class='group aggregation_type'>
      <b>Rollup</b>
      <fn-dropdown id='rollup' data-style="input small">
        <fn-dropdown-header>Value</fn-dropdown-header>
        <fn-dropdown-item data-value='value'>Value</fn-dropdown-item>
        <fn-dropdown-item data-value='sum'>Sum</fn-dropdown-item>
        <fn-dropdown-item data-value='min'>Min</fn-dropdown-item>
        <fn-dropdown-item data-value='max'>Max</fn-dropdown-item>
      </fn-dropdown>
    </div>
    <div class='group aggregation_time_window'>
      <b>Time Window / Step</b>
      <fn-dropdown id='time_window' data-style="input small">
        <fn-dropdown-header>5 seconds</fn-dropdown-header>
        <fn-dropdown-item data-value=1>1 second</fn-dropdown-item>
        <fn-dropdown-item data-value=5>5 seconds</fn-dropdown-item>
        <fn-dropdown-item data-value=10>10 seconds</fn-dropdown-item>
        <fn-dropdown-item data-value=20>20 seconds</fn-dropdown-item>
        <fn-dropdown-item data-value=30>30 seconds</fn-dropdown-item>
        <fn-dropdown-item data-value=60>1 minute</fn-dropdown-item>
        <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
        <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
        <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
        <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
        <fn-dropdown-item data-value=7200>2 hours</fn-dropdown-item>
        <fn-dropdown-item data-value=21600>6 hours</fn-dropdown-item>
        <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
        <fn-dropdown-item data-value=86400>24 hours</fn-dropdown-item>
      </fn-dropdown>
      <fn-dropdown id='time_step' data-style="input small">
        <fn-dropdown-header>5 seconds</fn-dropdown-header>
        <fn-dropdown-item data-value=1>1 second</fn-dropdown-item>
        <fn-dropdown-item data-value=5>5 seconds</fn-dropdown-item>
        <fn-dropdown-item data-value=10>10 seconds</fn-dropdown-item>
        <fn-dropdown-item data-value=20>20 seconds</fn-dropdown-item>
        <fn-dropdown-item data-value=30>30 seconds</fn-dropdown-item>
        <fn-dropdown-item data-value=60>1 minute</fn-dropdown-item>
        <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
        <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
        <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
        <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
        <fn-dropdown-item data-value=7200>2 hours</fn-dropdown-item>
        <fn-dropdown-item data-value=21600>6 hours</fn-dropdown-item>
        <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
        <fn-dropdown-item data-value=86400>24 hours</fn-dropdown-item>
      </fn-dropdown>
    </div>
    <div class="group scale">
      <b>Scale</b>
      <fn-input id="scale_input" class="left" data-style="small"></fn-input>
    </div>
    <div class="group group_by">
      <b>Group by</b>
    </div>
  </div>
  <div class='right'>
    <fn-button id="add_metric" data-size="tiny">
      <i class="fa fa-plus"></i>
    </fn-button>
  </div>
  <fn-tooltip id='tooltip_aggr'>
    There's no time-window aggregation for the current rollup
  </fn-tooltip>

</template>

<script type='text/javascript'>
  var MetricControlComponent = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-metric-control", "base");
      var shadow = this.createShadowRoot();
      shadow.appendChild(tpl);

      if (this.hasAttribute('data-metric')) {this.init() }
    }

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if(attr == "data-metric") {
        this.init();
      }
    }


    this.handleAggregationDisplay = function() {
      var view = this.getAttribute('data-rollup');
      var time_window = this.shadowRoot.getElementById("time_window");
      var time_step = this.shadowRoot.getElementById("time_step");
      if (view == "value" ) {
        time_window.setAttribute("data-state", "disabled");
        time_step.setAttribute("data-state", "disabled");
      } else {
        time_window.removeAttribute("data-state");
        time_step.removeAttribute("data-state");
      }
    };

    this.init = function() {
      this.handleControls();
      this.handleSelectMetricControls();
      this.handleAggregationDisplay();
    };

    this.handleSelectMetricControls = function() {
      var base = this;
      this.shadowRoot.querySelector(
        ".metric .view i[name='edit_btn']").onclick = function() {
          console.log("clicked");
          base.toggleMetricView();
        }

      this.shadowRoot.querySelector(
        ".metric .view i[name='close_btn']").onclick = function() {
          console.log("clicked");
          base.toggleMetricView();
        }



      
    }

    this.toggleMetricView = function() {
      this.shadowRoot.querySelector(
        ".metric .view[name='header']").classList.toggle("active");

      this.shadowRoot.querySelector(
        ".metric .view[name='search']").classList.toggle("active");
    }

    this.handleControls = function() {
      var base = this;
      this.shadowRoot.querySelector("h3").innerHTML = this.getAttribute('data-metric');
      var rollup = this.shadowRoot.getElementById("rollup");
      rollup.setAttribute('data-preselected', this.getAttribute('data-rollup'));

      var time_window = this.shadowRoot.getElementById("time_window");
      time_window.setAttribute('data-preselected', this.getAttribute('data-aggr_window'));

      var time_step = this.shadowRoot.getElementById("time_step");
      time_step.setAttribute('data-preselected', this.getAttribute('data-aggr_step'));

      var scale_input = this.shadowRoot.getElementById("scale_input");
      scale_input.setAttribute('data-value', this.getAttribute('data-scale'));
      scale_input.setAttribute('data-placeholder', this.getAttribute('data-scale'));

      var tooltip_aggr = this.shadowRoot.getElementById("tooltip_aggr");
      tooltip_aggr.initShowIf(time_window, function() {
        return (time_window.getAttribute('data-state') == 'disabled');
      });

      tooltip_aggr.initShowIf(time_step, function() {
        return (time_step.getAttribute('data-state') == 'disabled');
      });

      rollup.addEventListener("fn-dropdown-item-click", function(e) {
        var view = e.srcElement.getAttribute('data-value');
        base.setAttribute("data-rollup", view);
        base.handleAggregationDisplay();
        base.attributeChangedEvent({"view" : view});
      }, false);

      time_window.addEventListener("fn-dropdown-item-click", function(e) {
        var value = e.srcElement.getAttribute('data-value');
        base.setAttribute('data-aggr_window', value);
        base.attributeChangedEvent({"aggr_window": value});
      }, false);

      time_step.addEventListener("fn-dropdown-item-click", function(e) {
        var value = e.srcElement.getAttribute('data-value');
        base.setAttribute('data-aggr_step', value);
        base.attributeChangedEvent({"aggr_step": value});
      }, false);

      scale_input.addEventListener('fn-input-submit', function(e) {
        base.setAttribute('data-scale', e.detail);
        base.attributeChangedEvent({"scale" : e.detail});
      }, false);
    }

    this.handleGroupByControls = function(columns) {
      var base = this;

     /* var columns = this.splitColumns(this.("columns"));
      var by = this.splitColumns(this.getQueryParamOrDefaultValue("by"));

      if (columns.length > 0 ) {
        group_by_field.className += " active";
      }

      columns.map(function(c) {
        var button = document.createElement("fn-button");
        button.innerHTML = c;
        if (by.indexOf(c) > -1) {
          button.setAttribute("data-active", "active");
        }
        group_by_field.appendChild(button);
        button.addEventListener("fn-button-click", function() {
          var isActive = this.hasAttribute("data-active");
          var columns = base.getQueryParamOrDefaultValue("by");
          if (isActive) {
            this.removeAttribute("data-active");
            columns = FnordMetric.util.removeFromCSV(columns, this.innerText);
          } else {
            this.setAttribute("data-active", "active");
            columns = FnordMetric.util.addToCSV(columns, this.innerText);
          }
          base.updateUrlParams({"by": columns});
        });
      });*/
    };

    this.attributeChangedEvent = function(attr) {
      var attrEvent = new CustomEvent(
        'fn-metric-control-attr-changed', {
        "detail" : attr,
        bubbels: true,
        cancelable: true
      });

      this.dispatchEvent(attrEvent);
    }


  };
  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent("fn-metric-control", MetricControlComponent);
  }, false);
</script>
