<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id="fn-metric-explorer-preview-base-tpl">
  <style type='text/css'>
    .navigation fn-button {
      margin: 5px 8px 0 0;
    }



    .group {
      height: 100%;
      float: left;
      padding: 14px 20px 0 20px;
    }


    .group b {
      font-weight: normal;
      font-size: 80%;
      line-height: 12px;
      font-weight: 500;
      display: block;
      margin-bottom: 6px;
      opacity: 0.7;
    }

    .group.timenav {
      padding: 0;
    }

    .group.timenav * {
      float:left;
    }

    .group.timenav fn-datepicker {
      margin: 3px 10px 0 10px;
    }

    #result_pane_loader fn-message {
      display:none;
      margin: 2em 4em;
    }

    #result_pane_loader fn-message.active {
      display: block;
    }

    .result_pane {
      padding: 10px 0 20px;
      background: #fff;
      display: none;
    }

    .result_pane.active {
      display: block;
    }

    #raw.result_pane {
      padding: 10px 10px 20px;
    }

    fn-controls /deep/ .controls_inner {
      border-top: 1px solid #bbb;
    }

    fn-controls[type='secondary'] /deep/ .controls_inner {
      border-bottom: none !important;
    }


    .result_pane fn-pager {
      float:right;
      margin-right: 5px;
    }

  </style>
  <fn-loader>
    <div class="navigation">
      <fn-button id="embed_btn" data-size='tiny'>
        <i class='fa fa-share'></i>
        Embed
      </fn-button>
      <fn-button id="auto_refresh" data-toggle data-size='tiny'>
        <i class='fa fa-refresh'></i>
        Auto Refresh
      </fn-button>
      <fn-button data-format="csv" style="margin-right:15px;" class="right" data-size="tiny">Raw</fn-button>
      <fn-button data-format="svg" class="right" data-state="active" data-size="tiny">Chart</fn-button>
    </div>
    <fn-metric-control data-index="0"></fn-metric-control>
    <fn-controls type='secondary'>
      <fn-controls-section data-position='left'>
        <div class="group timenav">
          <fn-dropdown id='timerange' data-style="input small">
            <fn-dropdown-header>1 hour</fn-dropdown-header>
            <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
            <fn-dropdown-item data-value=14400>4 hours</fn-dropdown-item>
            <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
            <fn-dropdown-item data-value=86400>1 day</fn-dropdown-item>
          </fn-dropdown>
          <fn-datepicker data-time-select data-selectable="past">
          </fn-datepicker>

          <fn-daterangepicker data-size="small" data-selectable='past'>
          </fn-daterangepicker>
        </div>
      </fn-controls-section>
      <fn-controls-section data-position='right'>
        <fn-checkbox data-style="small" id="inv_scale" style="margin-right: 10px;">
          <fn-checkbox-label>Inverted</fn-checkbox-label>
        </fn-checkbox>
        <fn-checkbox data-style="small" id="log_scale">
          <fn-checkbox-label>Logarithmic</fn-checkbox-label>
        </fn-checkbox>
      </fn-controls-section>
    </fn-controls>
    <fn-loader id="result_pane_loader" data-loading data-resolved="data-resolved" data-transparent>
      <fn-message data-state='error'></fn-message>
      <div class="result_pane active" data-format="svg">
      </div>
      <div class="result_pane" data-format="csv">
        <fn-table data-per-page="25" data-page="0">
          <fn-table-column>Metric</fn-table-column>
          <fn-table-column>Time</fn-table-column>
          <fn-table-column>Value</fn-table-column>
          <table>
          </table>
        </fn-table>
      </div>
    </fn-loader>
    <fn-modal id="embed">
      <fn-modal-header>Embed</fn-modal-header>
      <fn-modal-content>
        <div class="header">Copy this into your HTML Page</div>
        <code>
          &lt;iframe<br />&nbsp;&nbsp;&nbsp;&nbsp;width="800"<br />
          &nbsp;&nbsp;&nbsp;&nbsp;height="400"<br />
          &nbsp;&nbsp;&nbsp;&nbsp;frameBorder="0"<br />
          &nbsp;&nbsp;&nbsp;&nbsp;src="<span id="src"></span>"
          &gt;<br />&lt;/iframe&gt;
        </code>
      </fn-modal-content>
    </fn-modal>
  </fn-loader>
  <fn-tooltip data-pointer="right" id='ttp_endtime'>
    Please select a date in the past
  </fn-tooltip>
</template>

<script type='text/javascript'>
  var MetricExplorerPreview = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-metric-explorer-preview", "base");
      this.appendChild(tpl);

      if (this.getAttribute('data-url') != null) {
        this.onUrlChange(true);
      }

    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      switch (attr) {
        case 'data-url' :
          this.onUrlChange(old_val == null);
          break;
        case 'data-format' :
          this.toggleView(new_val);
          break;
        default:
          break;
      }
    };

    this.onUrlChange = function(init) {
      this.params = parseMetricQueryUrl(this.getAttribute("data-url"));
      if (init) {
        this.init();
      }

      this.updateData(this.getAttribute("data-format"));
    };


    this.init = function() {
      /*console.log(this.params);
      var base = this;
      var metric = this.params.query_params.innerViewValue;
      var url = baseUrl + "list?filter=" + encodeURIComponent(metric);
      control.setAttribute('data-rollup', this.getQueryParamOrDefaultValue("view"));
      control.setAttribute('data-aggr_window', this.getQueryParamOrDefaultValue("aggr_window"));
      control.setAttribute('data-aggr_step', this.getQueryParamOrDefaultValue("aggr_step"));
      control.setAttribute('data-scale', this.getQueryParamOrDefaultValue("scale"));
      control.setAttribute('data-metric', metric);


      Fnord.httpGet(url, function(r) {
        if (r.status == 200) {
          var json = JSON.parse(r.response);
          json.metrics.map(function(m) {
            base.columns = m.labels.join(",");
            //control.handleGroupByControls(m.labels.join(","));
          });
        }
        base.columns = [];
        base.updateUrlParams(
          base.addRequiredURLParamsForView(
            base.getQueryParamOrDefaultValue("view")));
        base.handleBasicControls();
        base.handleDateTimeControls();
        base.initNewMetric(base.querySelector("fn-metric-control"))
      });*/

      //init mainMetric
      this.initMetricControl(this.querySelector("fn-metric-control"), 0);

      //init subMetrics
      for (var i = 1; i < parseInt(this.params.metrics, 10); i++) {
        this.initMetricControl(this.addMetricControl(i), i);
      }

    };

    this.initMetricControl = function(metric, index) {
      metric.setAttribute('data-index', index);
      var metric_params = {
        "name": this.getMetricUrlParamOrDefault("name", index),
        "aggr_fn": this.getMetricUrlParamOrDefault("aggr_fn", index),
        "aggr_window": this.getMetricUrlParamOrDefault("aggr_window", index),
        "aggr_step": this.getMetricUrlParamOrDefault("aggr_step", index),
        "scale": this.getMetricUrlParamOrDefault("scale", index)
      }

      metric.params = metric_params;
      metric.setAttribute('data-resolved', 'resolved');

      /* handle events */
      metric.addEventListener(
        "fn-metric-control-attr-changed", function(e) {
          base.updateUrlParams(e.detail);
        },
      false);

      if (index > 0) {
        metric.addEventListener('fn-metric-control-remove-metric', function(e) {
          base.removeMetricControl();
        }, false);
      } else {
        metric.addEventListener('fn-metric-control-add-metric', function() {
          base.addMetricControl();
        }, false);
      }
    };



    this.getMetricUrlParamOrDefault = function(key, index) {
      var defaults = {
        "aggr_fn": "sum",
        "aggr_window": "5",
        "aggr_step": "10",
        "scale" : "0.8"
      }

      var value = this.params["metric" + index][key];
      if (value == undefined) {
        value = defaults[key];
      }

      return value;
    };

    this.getGenericParamsOrDefault = function(key) {
      var defaults = {
        end_time : Math.round(Date.now() / 1000),
        /* 5 minutes  */
        time_range : 3600,
        /* 10, 5 seconds */
        aggr_step : 10,
        aggr_window : 5,
        logarithmic : false,
        inverted: false,
        min: 0
      }

      if (key == "time_range") {
        var end_time = parseInt(this.getQueryParamOrDefaultValue("end_time"), 10);
        var start_time = parseInt(this.params['start_time'], 10);
        if (!isNaN(start_time)) {
          return end_time - start_time;
        } else {
          return defaults['time_range'];
        }
      }

      var value = (this.params.query_params[key])?
        this.params.query_params[key] : defaults[key];

      return value;
    }

    this.getQueryParamOrDefaultValue = function(key) {
      var defaults = {
        view : "sum",
        columns : this.columns,
                
        by: this.columns,
        min: 0,
        scale: 0.8
      }

      if (key == "time_range") {
        var end_time = parseInt(this.getQueryParamOrDefaultValue("end_time"), 10);
        var start_time = parseInt(this.params['start_time'], 10);
        if (!isNaN(start_time)) {
          return end_time - start_time;
        } else {
          return defaults['time_range'];
        }
      }

      var value = (this.params.query_params[key])?
        this.params.query_params[key] : defaults[key];

      return value;
    };


    this.buildQueryUrl = function(format) {
      var url =
        baseUrl + "timeseries" +
        "?metric=" + this.params.query_params.innerViewValue +
        "&from=" + this.getQueryParamOrDefaultValue("start_time") +
        "&until=" + this.getQueryParamOrDefaultValue("end_time") +
        "&logarithmic=" + this.getQueryParamOrDefaultValue("logarithmic") +
        "&inverted=" + this.getQueryParamOrDefaultValue("inverted");

      var view = this.getQueryParamOrDefaultValue("view");
      if (view != 'value') {
        url +=
          "&aggr_fn=" + view +
          "&aggr_window=" + this.getQueryParamOrDefaultValue("aggr_window") +
          "&aggr_step=" + this.getQueryParamOrDefaultValue("aggr_step");
      }

      url +=
        "&format=" + format +
        "&min=" + this.getQueryParamOrDefaultValue("min") +
        "&height=" + (document.body.offsetHeight - 255) +
        "&width=" + (document.body.offsetWidth - 20) +
        "&grid=both" +
        "&scale=" + this.getQueryParamOrDefaultValue("scale") +
        "&axis_right=true" +
        "&legend=toprightinside";

      return url;
    };

    this.toggleView = function(format) {
      this.querySelector(".result_pane.active").classList.remove("active");
      this.querySelector(".result_pane[data-format='"+ format +"']").classList.add("active");

      this.querySelector("fn-button[data-format][data-state='active']").removeAttribute("data-state");
      this.querySelector("fn-button[data-format='"+ format +"']").setAttribute("data-state", "active");

      this.updateData(format);
    };

    this.updateData = function(format) {
      var base = this;
      format = format ? format : "svg";
      var url = this.buildQueryUrl(format);

      Fnord.httpGet(url, function(r) {
        if (r.status == 200) {
          if (format == "csv") {
            base.renderCsvAsTable(r.response);
            return;
          }

          var pane = base.querySelector(".result_pane[data-format='"+ format +"']");
          pane.innerHTML = "";
          pane.innerHTML = r.response;
          base.querySelector("#result_pane_loader").removeAttribute("data-loading");
        }
      });
    };

    this.renderCsvAsTable = function(csv) {
      var fn_table = this.querySelector(".result_pane[data-format='csv'] fn-table");
      var table = fn_table.querySelector("table");
      var data_points = csv.split(/\n/);

      data_points.forEach(function(point) {
        var tr_elem = document.createElement("tr");

        point.split(";").forEach(function(entry) {
          var td_elem = document.createElement("td");
          td_elem.innerHTML = entry;
          tr_elem.appendChild(td_elem);
        });

        table.appendChild(tr_elem);
      });

      fn_table.renderTable();
      this.querySelector("#result_pane_loader").removeAttribute("data-loading");
    }


    /* returns all missing params */
    this.addRequiredURLParamsForView = function(view) {
      var new_params = {};
      var update = false;
      if (view == "count" ||
          view == "sum"   ||
          view == "mean"  ||
          view == "min"   ||
          view == "max" ) {

        var time_window = this.params.query_params.aggr_window;
        if (time_window == undefined) {
          new_params.aggr_window = this.getQueryParamOrDefaultValue("aggr_window");
          update = true;
        }
        var aggr_step = this.params.query_params.aggr_step;
        if (aggr_step == undefined) {
          new_params.aggr_step = this.getQueryParamOrDefaultValue("aggr_step");
          update = true;
        }
      }

      var group_by = this.params.query_params.by;
      if (group_by == undefined) {
        new_params.by = this.columns;
        update = true;
      }
      var param_columns = this.params.query_params.columns;
      if (param_columns == undefined) {
        new_params.columns = this.columns;
        update = true;
      }

      return new_params;
    };


    this.updateUrlParams = function(new_params) {
      for (var key in new_params) {
        if (new_params[key] != undefined) {
          this.params.query_params[key] = new_params[key].toString();
        }
      }
      var path = setUrlFromQueryString("metric", this.params.query_params, true);
      if (this.getAttribute('data-url') != path) {
        this.setAttribute("data-url", path);
      }
    };

    
    this.onRefresh = function() {
      var end_time = Date.now();
      var time_range = this.getQueryParamOrDefaultValue('time_range');
      var start_time = end_time - time_range;
      this.updateUrlParams({
        'end_time' : end_time,
        'start_time' : start_time});
    }

    this.addMetricControl = function(index) {
      var controls = this.querySelectorAll("fn-metric-control");
      var new_control = document.createElement("fn-metric-control");
      var ref_elem = this.querySelector("fn-controls[type='secondary']");
      var index = index;

      if (!index && controls) {
        index = parseInt(
          controls[controls.length - 1].getAttribute('data-index'), 10) + 1;
      }

      new_control.setAttribute('data-index', index);
      ref_elem.parentNode.insertBefore(new_control, ref_elem);

      return new_control;
    };

    this.removeMetricControl = function(index) {

    }

/************************* controls handle functions **************************/

    this.splitColumns = function(columns) {
      if (columns.length == 0) {return [];}

      return columns.split(",");
    }

    this.updateDateTimeElems = function(end_time) {
      var params = parseUrlQueryString(this.getAttribute("data-url"));
      var date_range = this.getQueryParamOrDefaultValue("time_range");
      var start_time = parseInt(end_time, 10) - parseInt(date_range, 10);
      this.updateUrlParams({"end_time" : end_time, "start_time" : start_time});
      var datepicker = this.querySelector("fn-datepicker");
      datepicker.setAttribute("data-timestamp", end_time * 1000);
      var daterangepicker = this.querySelector("fn-daterangepicker");
      daterangepicker.setAttribute("data-endtime", end_time * 1000);
    };


    this.handleDateTimeControls = function() {
      var base = this;
      /* init */
      var time_range_val = parseInt(
        this.getQueryParamOrDefaultValue("time_range"), 10);
      var end_time = parseInt(this.getQueryParamOrDefaultValue("end_time"), 10);

      var time_range = this.querySelector("#timerange");
      time_range.setAttribute('data-preselected', time_range_val);

      var datepicker = this.querySelector("fn-datepicker");
      datepicker.setAttribute('data-timestamp', (end_time * 1000));

      var daterangepicker = this.querySelector("fn-daterangepicker");
      daterangepicker.setAttribute('data-daterange', (time_range_val * 1000));
      daterangepicker.setAttribute('data-endtime', (end_time * 1000));

      var chevron_right = daterangepicker.shadowRoot.querySelector(".fa-chevron-right");

      var tooltip = this.querySelector("#ttp_endtime");
      tooltip.initShowIf(chevron_right, function() {
        return !(daterangepicker.nextIsSelectable());
      });

      time_range.addEventListener("fn-dropdown-item-click", function(e) {
        var endtime = base.getQueryParamOrDefaultValue("end_time");
        var date_range = parseInt(e.srcElement.getAttribute('data-value'));
        var starttime = parseInt(endtime, 10) - date_range;
        base.updateUrlParams({"start_time": starttime});
        //check
        daterangepicker.setAttribute("data-daterange", (date_range * 1000));
      }, false);

      datepicker.addEventListener('fn-datepicker-select', function() {
        var timestamp = parseInt(this.getAttribute("data-timestamp"), 10);
        timestamp = Math.round(timestamp / 1000);
        base.updateDateTimeElems(timestamp);
      }, false);

      daterangepicker.addEventListener('fn-daterangepicker-select-previous', 
        function() {
          var endtime = parseInt(this.getAttribute("data-endtime"), 10);
          endtime = Math.round(endtime / 1000);
          base.updateDateTimeElems(endtime);
      }, false);

      daterangepicker.addEventListener('fn-daterangepicker-select-next',
        function() {
          var endtime = parseInt(this.getAttribute("data-endtime"), 10);
          endtime = Math.round(endtime / 1000);
          base.updateDateTimeElems(endtime);
      }, false);

    }

    this.handleBasicControls = function() {
      var base = this;
      /* init */
      var log_scale = this.querySelector("#log_scale");
      var inv_scale = this.querySelector("#inv_scale");
      if (this.getQueryParamOrDefaultValue("logarithmic")) {
        log_scale.setAttribute("data-preselected", true);
      }
      if (this.getQueryParamOrDefaultValue("inverted")) {
        inv_scale.setAttribute("data-preselected", true);
      }

      /* handle Events */
      this.querySelector("fn-button[data-format='csv']").addEventListener('fn-button-click', function() {
        base.setAttribute("data-format", "csv");
      }, false);

      this.querySelector("fn-button[data-format='svg']").addEventListener('fn-button-click', function() {
        base.setAttribute("data-format", "svg");
      }, false);

      log_scale.addEventListener("fn-checkbox-select", function(e) {
        base.updateUrlParams({"logarithmic" : true});
      }, false);

      inv_scale.addEventListener("fn-checkbox-select", function(e) {
        base.updateUrlParams({"inverted" : true});
      }, false);

      log_scale.addEventListener("fn-checkbox-unselect", function(e) {
        base.updateUrlParams({"logarithmic" : false});
      }, false);

      inv_scale.addEventListener("fn-checkbox-unselect", function(e) {
        base.updateUrlParams({"inverted" : false});
      }, false);

      var interval_id;
      this.querySelector("#auto_refresh").addEventListener('fn-button-click', function() {
        if (this.getAttribute('data-state') == "active") {
          window.clearInterval(interval_id);
          this.removeAttribute('data-state');
        } else {
          interval_id = window.setInterval(function() {base.onRefresh(); }, 30000);
          this.setAttribute('data-state', 'active');
        }
      }, false);

      var modal = this.querySelector("fn-modal");
      this.querySelector("#embed_btn").addEventListener('fn-button-click', function() {
        modal.querySelector("span").innerHTML = baseUrl + base.getAttribute('data-url');
        modal.show();
      }, false);
    };
  };

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-metric-explorer-preview', MetricExplorerPreview);
  }, false);
</script>


