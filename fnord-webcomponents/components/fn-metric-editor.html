<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id='fn-metric-editor-base-tpl'>
  <fn-modal-dimmer>
    <fn-modal>
      <fn-modal-close-icon></fn-modal-close-icon>

      <fn-metric-editor-recent class='me-modal-window active'>
        <fn-metric-editor-header>
          <fn-metric-editor-header-title>Recent Metrics</fn-metric-editor-header-title>
          <fn-button data-action='metric-create'>
            <i class='fa fa-plus'></i> New Metric
          </fn-button>
        </fn-metric-editor-header>

        <fn-loader data-loading>
          <fn-metrics></fn-metrics>
        </fn-loader>

        <template id='fn-metrics-empty-tpl'>
          <fn-metrics-empty>
            <div class='segment-text'>No Metrics Found</div>
            <div class='segment-link'>Add a new Metric</div>
          </fn-metrics-empty>
        </template>
      </fn-metric-editor-recent>

      <fn-metric-options id='fn-metric-options-tpl'>

        <fn-metric-option>
          <fn-metric-option-title>Draw</fn-metric-option-title>
          <fn-dropdown data-key='chart' data-resolved class='input'>
            <fn-dropdown-items>
              <fn-dropdown-item data-value='line'>Linechart</fn-dropdown-item>
              <fn-dropdown-item data-value='area'>Areachart</fn-dropdown-item>
              <fn-dropdown-item data-value='bar'>Barchart</fn-dropdown-item>
              <fn-dropdown-item data-value='point'>Pointchart</fn-dropdown-item>
            </fn-dropdown-items>
          </fn-dropdown>
        </fn-metric-option>

        <fn-metric-option>
          <fn-metric-option-title>Rollup</fn-metric-option-title>
          <fn-dropdown data-key='rollup' data-resolved class='input'>
            <fn-dropdown-items>
              <fn-dropdown-item data-value='value'>Value</fn-dropdown-item>
              <fn-dropdown-item data-value='sum'>Sum</fn-dropdown-item>
              <fn-dropdown-item data-value='count'>Count</fn-dropdown-item>
              <fn-dropdown-item data-value='min'>Min</fn-dropdown-item>
              <fn-dropdown-item data-value='max'>Max</fn-dropdown-item>
              <fn-dropdown-item data-value='mean'>Mean</fn-dropdown-item>
              <fn-dropdown-item data-value='median'>Median</fn-dropdown-item>
              <fn-dropdown-item data-value='rollup mean'>Rollup Mean</fn-dropdown-item>
              <fn-dropdown-item data-value='rollup count'>Rollup Count</fn-dropdown-item>
              <fn-dropdown-item data-value='rollup sum'>Rollup Sum</fn-dropdown-item>
            </fn-dropdown-items>
          </fn-dropdown>
        </fn-metric-option>

        <fn-metric-option data-key='time_aggr'>
          <fn-metric-option-title>Time Window / Step</fn-metric-option-title>
          <fn-dropdown data-key='time_window' data-resolved class='input'>
            <fn-dropdown-items>
              <fn-dropdown-item data-value=1>1 second</fn-dropdown-item>
              <fn-dropdown-item data-value=5>5 seconds</fn-dropdown-item>
              <fn-dropdown-item data-value=10>10 seconds</fn-dropdown-item>
              <fn-dropdown-item data-value=20>20 seconds</fn-dropdown-item>
              <fn-dropdown-item data-value=30>30 seconds</fn-dropdown-item>
              <fn-dropdown-item data-value=60>1 minute</fn-dropdown-item>
              <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
              <fn-dropdown-item data-value=7200>2 hours</fn-dropdown-item>
              <fn-dropdown-item data-value=21600>6 hours</fn-dropdown-item>
              <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
              <fn-dropdown-item data-value=86400>24 hours</fn-dropdown-item>
            </fn-dropdown-items>
          </fn-dropdown>

          <fn-dropdown data-key='time_step' data-resolved class='input'>
            <fn-dropdown-items>
              <fn-dropdown-item data-value=1>1 second</fn-dropdown-item>
              <fn-dropdown-item data-value=5>5 seconds</fn-dropdown-item>
              <fn-dropdown-item data-value=10>10 seconds</fn-dropdown-item>
              <fn-dropdown-item data-value=20>20 seconds</fn-dropdown-item>
              <fn-dropdown-item data-value=30>30 seconds</fn-dropdown-item>
              <fn-dropdown-item data-value=60>1 minute</fn-dropdown-item>
              <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
              <fn-dropdown-item data-value=7200>2 hours</fn-dropdown-item>
              <fn-dropdown-item data-value=21600>6 hours</fn-dropdown-item>
              <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
              <fn-dropdown-item data-value=86400>24 hours</fn-dropdown-item>
            </fn-dropdown-items>
          </fn-dropdown>
        </fn-metric-option>

        <fn-metric-option>
          <fn-metric-option-title>Show the last...</fn-metric-option-title>
          <fn-dropdown data-resolved class='input' data-key='timerange'>
            <fn-dropdown-items>
              <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
              <fn-dropdown-item data-value=14400>4 hours</fn-dropdown-item>
              <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
              <fn-dropdown-item data-value=86400>1 day</fn-dropdown-item>
            </fn-dropdown-items>
          </fn-dropdown>
        </fn-metric-option>

        <fn-metric-option data-key='until'>
          <fn-metric-option-title>Endtime</fn-metric-option-title>
        </fn-metric-option>

      </fn-metric-options>


      <fn-metric-editor-create class='me-modal-window'>
         <fn-metric-editor-header>
            <input class='fn-input' placeholder='Metric Name' data-segment-name />
            <fn-metric-editor-msg class='me-error' name='name'>Please insert a (unique) name</fn-metric-editor-msg>
            <fn-metric-editor-msg class='me-error' name='option'>Please select at least one option</fn-metric-editor-msg>

            <fn-button data-action='show-recent'>Cancel</fn-button>
            <fn-button data-action='save-create'>Save</fn-button>
          </fn-metric-editor-header>

          <fn-metric-options></fn-metric-options>
      </fn-metric-editor-create>

      <fn-metric-editor-edit class='me-modal-window'>
        <fn-metric-editor-header>
          <input class='fn-input' data-metric-name />

          <fn-button data-action='show-recent'>Cancel</fn-button>
          <fn-button data-action='replace-metric'>Save</fn-button>
        </fn-metric-editor-header>

        <fn-metric-options></fn-metric-options>
      </fn-metric-editor-edit>
    </fn-modal>
  </fn-modal-dimmer>
</template>

<script type='text/javascript'>
  var FnordMetricEditor = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-metric-editor", "base");
      this.appendChild(tpl);
      this.init();
    }

    this.init = function() {
      var _this = this;
      this.querySelector("fn-button[data-action='metric-create']").onclick =
        function() {
          _this.showMetricCreate();
        }

      this.querySelector("fn-button[data-action='save-create']").onclick =
        function() {
          _this.onMetricCreation();
        }

      var show_recent_btns = this.querySelectorAll(
        "fn-button[data-action='show-recent']");

      for (var i = 0; i < show_recent_btns.length; i++) {
        show_recent_btns[i].onclick = function() {
          _this.showMetricRecent();
        }
      }
    };


    this.buildMetric = function(elem, callback) {
      var metric = {};

      metric.name = elem.querySelector("input").value;
      if (metric.name.length == 0) {
        elem.querySelector("fn-metric-editor-msg[name='name']")
          .classList.add("active");
        return;
      }
      metric.key = metric.name.replace(" ", "_");
      metric.rules = [];

      for (var i = 0; i < this.optionPreselection.length; i++) {
        var option = elem.querySelector("[data-key='" + key + "']");
        metric.rules.push({
          field: this.optionPreselection[i].field,
          opt: this.optionPreselection[i].opt,
          values: [option.getValue()]});
      }

      callback(metric);
    }


    this.onMetricCreation = function() {
      var view = this.querySelector("fn-metric-editor-create");
      var _this = this;
      this.buildMetric(view, function(metric) {
        _this.fireNewMetricEvent(metric);
      });
    }

    this.show = function(view) {
      var modal = this.querySelector("fn-modal");
      modal.show();

      if (view) {
        return this.changeView(view);
      }

      this.showMetricRecent();
    }

    this.showMetricRecent = function() {
      var _this = this;
      this.changeView("fn-metric-editor-recent");

      if (typeof this.loadRecentMetrics == "function") {
        this.loadRecentMetrics(function(metrics) {
          _this.renderRecentMetrics(metrics);
        });
      } else {
        this.renderRecentMetrics([]);
      }
    }

    this.optionPreselection = [
      {"field" : 'chart', "opt" : "matches", "values" : ['line']},
      {"field" : 'rollup', "opt" : "matches", "values" : ['value']},
      {"field" : 'time_window', "opt" : "matches", "values" : ['5']},
      {"field" : 'time_step', "opt" : "matches", "values" : ['10']},
      {"field" : 'timerange', "opt" : "matches", "values" : ['3600']}
    ];

    this.setOptionSelection = function(elem, selection) {
      for (var i = 0; i < selection.length; i++) {
        var option = elem.querySelector("[data-key='" + selection[i].field + "']");
        option.setValue(selection[i].values);
      }
    }


    this.showMetricCreate = function() {
      var view = this.querySelector("fn-metric-editor-create");
      var options = view.querySelector("fn-metric-options");
      var options_tpl = this.querySelector("#fn-metric-options-tpl");
      options.innerHTML = "";
      options.appendChild(options_tpl.cloneNode(true));

      view.querySelector("input").value = "";
      this.setOptionSelection(options, this.optionPreselection);
      this.hideErrorMessages(view);
      this.changeView("fn-metric-editor-create");

    };


    this.hideErrorMessages = function(elem) {
      var msg = elem.querySelectorAll("fn-metric-editor-msg.me-error.active");
      for (var i = 0; i < msg.length; i++) {
        msg[i].classList.remove("active");
      }
    }


    this.renderRecentMetrics = function(metrics) {
      var view = this.querySelector("fn-metric-editor-recent");
      var container = view.querySelector("fn-metrics");
      container.innerHTML = "";

      if (metrics.length == 0) {
        var tpl = view.querySelector("#fn-metrics-empty-tpl");
        container.appendChild(tpl.content.querySelector("fn-metrics-empty"));
        view.querySelector("fn-loader").removeAttribute("data-loading");
        //TODO observe add new metric link
        return;
      }


      var _this = this;
      metrics.forEach(function(metric) {
        var elem = document.createElement("fn-metric-editor-metric");
        elem.innerHTML = metric.name;
        container.appendChild(elem);
      });

      view.querySelector("fn-loader").removeAttribute("data-loading");
    };


    this.changeView = function(new_view) {
      var old_view = this.querySelector(".me-modal-window.active");
      if (old_view) {
        old_view.classList.remove("active");
      }

      this.querySelector(new_view).classList.add("active");
    }

    this.editMetric = function(metric) {
      console.log(metric.rules);
      var view = this.querySelector("fn-metric-editor-edit");
      var options = view.querySelector("fn-metric-options");
      var options_tpl = this.querySelector("#fn-metric-options-tpl");
      options.innerHTML = "";
      options.appendChild(options_tpl.cloneNode(true));

      view.querySelector("input").value = metric.name;

      this.setOptionSelection(options, metric.rules);
      this.hideErrorMessages(view);
      this.show("fn-metric-editor-edit");

    };

    this.fireNewMetricEvent = function(metric) {
      
    }
  }

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-metric-editor', FnordMetricEditor);
  });
</script>
