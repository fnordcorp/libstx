<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id='fn-metric-editor-base-tpl'>
  <fn-modal-dimmer>
    <fn-modal>
      <fn-modal-close-icon></fn-modal-close-icon>

      <fn-metric-editor-recent class='me-modal-window active'>
        <fn-metric-editor-header>
          <fn-metric-editor-header-title>Recent Metrics</fn-metric-editor-header-title>
          <fn-button data-action='metric-create'>
            <i class='fa fa-plus'></i> New Metric
          </fn-button>
        </fn-metric-editor-header>

        <fn-loader data-loading>
          <fn-metrics></fn-metrics>
        </fn-loader>

        <template id='fn-metrics-empty-tpl'>
          <fn-metrics-empty>
            <div class='segment-text'>No Metrics Found</div>
            <div class='segment-link'>Add a new Metric</div>
          </fn-metrics-empty>
        </template>
      </fn-metric-editor-recent>

      <fn-metric-options id='fn-metric-options-tpl'>
        <fn-menu class='metric-option-menu'>
          <fn-menu-item data-index='0' data-active>
            Chart
          </fn-menu-item>
          <fn-menu-item data-index='1'>
            Aggregation
          </fn-menu-item>
          <fn-menu-item data-index='2'>
            Timerange
          </fn-menu-item>
        </fn-menu>

        <fn-metric-option-block data-index='0' data-active>
          <fn-metric-option data-key='chart'>
            <fn-metric-option-title>Draw</fn-metric-option-title>
            <fn-dropdown data-key='chart' data-resolved class='input'>
              <fn-dropdown-items>
                <fn-dropdown-item data-value='line'>Linechart</fn-dropdown-item>
                <fn-dropdown-item data-value='area'>Areachart</fn-dropdown-item>
                <fn-dropdown-item data-value='bar'>Barchart</fn-dropdown-item>
                <fn-dropdown-item data-value='point'>Pointchart</fn-dropdown-item>
              </fn-dropdown-items>
            </fn-dropdown>
        </fn-metric-option-block>

        <fn-metric-option-block data-index='1'>
          <fn-metric-option data-key='rollup'>
            <fn-metric-option-title>Rollup</fn-metric-option-title>
            <fn-dropdown data-key='rollup' data-resolved class='input'>
              <fn-dropdown-items>
                <fn-dropdown-item data-value='value'>Value</fn-dropdown-item>
                <fn-dropdown-item data-value='sum'>Sum</fn-dropdown-item>
                <fn-dropdown-item data-value='count'>Count</fn-dropdown-item>
                <fn-dropdown-item data-value='min'>Min</fn-dropdown-item>
                <fn-dropdown-item data-value='max'>Max</fn-dropdown-item>
                <fn-dropdown-item data-value='mean'>Mean</fn-dropdown-item>
                <fn-dropdown-item data-value='median'>Median</fn-dropdown-item>
                <fn-dropdown-item data-value='rollup mean'>Rollup Mean</fn-dropdown-item>
                <fn-dropdown-item data-value='rollup count'>Rollup Count</fn-dropdown-item>
                <fn-dropdown-item data-value='rollup sum'>Rollup Sum</fn-dropdown-item>
              </fn-dropdown-items>
            </fn-dropdown>
          </fn-metric-option>

          <fn-metric-option data-key='time_aggr'>
            <fn-metric-option-title>Time Window / Step</fn-metric-option-title>
            <fn-dropdown data-key='time_window' data-resolved class='input'>
              <fn-dropdown-items>
                <fn-dropdown-item data-value=1>1 second</fn-dropdown-item>
                <fn-dropdown-item data-value=5>5 seconds</fn-dropdown-item>
                <fn-dropdown-item data-value=10>10 seconds</fn-dropdown-item>
                <fn-dropdown-item data-value=20>20 seconds</fn-dropdown-item>
                <fn-dropdown-item data-value=30>30 seconds</fn-dropdown-item>
                <fn-dropdown-item data-value=60>1 minute</fn-dropdown-item>
                <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
                <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
                <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
                <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
                <fn-dropdown-item data-value=7200>2 hours</fn-dropdown-item>
                <fn-dropdown-item data-value=21600>6 hours</fn-dropdown-item>
                <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
                <fn-dropdown-item data-value=86400>24 hours</fn-dropdown-item>
              </fn-dropdown-items>
            </fn-dropdown>

            <fn-dropdown data-key='time_step' data-resolved class='input'>
              <fn-dropdown-items>
                <fn-dropdown-item data-value=1>1 second</fn-dropdown-item>
                <fn-dropdown-item data-value=5>5 seconds</fn-dropdown-item>
                <fn-dropdown-item data-value=10>10 seconds</fn-dropdown-item>
                <fn-dropdown-item data-value=20>20 seconds</fn-dropdown-item>
                <fn-dropdown-item data-value=30>30 seconds</fn-dropdown-item>
                <fn-dropdown-item data-value=60>1 minute</fn-dropdown-item>
                <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
                <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
                <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
                <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
                <fn-dropdown-item data-value=7200>2 hours</fn-dropdown-item>
                <fn-dropdown-item data-value=21600>6 hours</fn-dropdown-item>
                <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
                <fn-dropdown-item data-value=86400>24 hours</fn-dropdown-item>
              </fn-dropdown-items>
            </fn-dropdown>
          </fn-metric-option>
        </fn-metric-option-block>

        <fn-metric-option-block data-index='2'>
          <fn-metric-option data-key='timerange'>
            <fn-metric-option-title>Show the last...</fn-metric-option-title>
            <fn-dropdown data-resolved class='input'>
              <fn-dropdown-items>
                <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
                <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
                <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
                <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
                <fn-dropdown-item data-value=14400>4 hours</fn-dropdown-item>
                <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
                <fn-dropdown-item data-value=86400>1 day</fn-dropdown-item>
              </fn-dropdown-items>
            </fn-dropdown>
          </fn-metric-option>

          <fn-metric-option data-key='until'>
            <fn-metric-option-title>Endtime</fn-metric-option-title>
          </fn-metric-option>
        </fn-metric-option-block>

      </fn-metric-options>


      <fn-metric-editor-create class='me-modal-window'>
         <fn-metric-editor-header>
            <input class='fn-input' placeholder='Metric Name' data-segment-name />
            <fn-metric-editor-msg class='me-error' name='name'>Please insert a (unique) name</fn-metric-editor-msg>
            <fn-metric-editor-msg class='me-error' name='option'>Please select at least one option</fn-metric-editor-msg>

            <fn-button data-action='cancel-create'>Cancel</fn-button>
            <fn-button data-action='save-create'>Save</fn-button>
          </fn-metric-editor-header>

          <fn-metric-options></fn-metric-options>
      </fn-metric-editor-create>

      <fn-metric-editor-edit class='me-modal-window'>
        <fn-metric-editor-header>
          <input class='fn-input' data-metric-name />

          <fn-button data-action='cancel-edit'>Cancel</fn-button>
          <fn-button data-action='replace-metric'>Save</fn-button>
        </fn-metric-editor-header>

        <fn-metric-options></fn-metric-options>
      </fn-metric-editor-edit>
    </fn-modal>
  </fn-modal-dimmer>
</template>

<script type='text/javascript'>
  var FnordMetricEditor = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-metric-editor", "base");
      this.appendChild(tpl);
      this.init();
    }

    this.init = function() {
      var _this = this;
      this.querySelector("fn-button[data-action='metric-create']").onclick =
        function() {
          _this.showMetricCreate();
        }

      this.querySelector("fn-button[data-action='save-create']").onclick =
        function() {
          console.log("save created metric");
        }

      this.querySelector("fn-button[data-action='cancel-create']").onclick =
        function() {
          _this.showMetricRecent();
        }
    }

    this.show = function() {
      var modal = this.querySelector("fn-modal");
      modal.show();
      this.showMetricRecent();
    }

    this.showMetricRecent = function() {
      var _this = this;
      this.changeView("fn-metric-editor-recent");

      if (typeof this.loadRecentMetrics == "function") {
        this.loadRecentMetrics(function(metrics) {
          _this.renderRecentMetrics(metrics);
        });
      } else {
        this.renderRecentMetrics([]);
      }
    }



    this.showMetricCreate = function() {
      var view = this.querySelector("fn-metric-editor-create");
      var options = view.querySelector("fn-metric-options");
      var options_tpl = this.querySelector("#fn-metric-options-tpl");
      options.innerHTML = "";
      options.appendChild(options_tpl.cloneNode(true));

      view.querySelector("input").value = "";
      this.changeView("fn-metric-editor-create");

      options.querySelector("fn-menu").addEventListener('fn-menu-item-click',
        function(e) {
          var target = e.srcElement || e.target;
          var index = target.getAttribute('data-index');
          options.querySelector("fn-metric-option-block[data-active]")
            .removeAttribute("data-active");
          options.querySelector("fn-metric-option-block[data-index='" + index + "']")
            .setAttribute('data-active', 'active');
        }, false);
    }

    this.renderRecentMetrics = function(metrics) {
      var view = this.querySelector("fn-metric-editor-recent");
      var container = view.querySelector("fn-metrics");
      container.innerHTML = "";

      if (metrics.length == 0) {
        var tpl = view.querySelector("#fn-metrics-empty-tpl");
        container.appendChild(tpl.content.querySelector("fn-metrics-empty"));
        view.querySelector("fn-loader").removeAttribute("data-loading");
        //TODO observe add new metric link
        return;
      }


      var _this = this;
      metrics.forEach(function(metric) {
        var elem = document.createElement("fn-metric-editor-metric");
        elem.innerHTML = metric.name;
        container.appendChild(elem);
      });

      view.querySelector("fn-loader").removeAttribute("data-loading");
    }

    this.changeView = function(new_view) {
      var old_view = this.querySelector(".me-modal-window.active");
      if (old_view) {
        old_view.classList.remove("active");
      }

      this.querySelector(new_view).classList.add("active");
    }

    this.editMetric = function(metric) {
      console.log(metric);
    }
  }

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-metric-editor', FnordMetricEditor);
  });
</script>
